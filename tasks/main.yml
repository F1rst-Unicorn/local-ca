---
  - fail: msg="You need to set caname, see README.md"
    when: caname is not defined

  - name: Set work dir
    set_fact:
      workdir: "secrets/pki/{{ caname }}"

  - name: Check if CA is initialized
    local_action: stat path="{{ workdir }}/pki"
    register: castat
    changed_when: False

  - name: Init PKI
    local_action: command ./easyrsa init-pki chdir="{{ workdir }}" serial=1
    when: not castat.stat.exists

  - name: Generate CA certificate
    local_action: command ./easyrsa --batch --req-cn="{{caname}} Ansible local PKI" build-ca nopass chdir="{{ workdir }}" serial=1
    when: not castat.stat.exists

  - name: Handle server certificate request
    include: server.yml
    when: server is defined

  - name: Handle client certificate request
    include: client.yml
    when: client is defined
    
  - name: Handle dual certificate request
    include: both.yml
    when: both is defined

  - name: Handle DH parameters request
    include: dhparam.yml
    when: dhparam is defined

  - name: Handle ca information request
    include: ca.yml
    when: ca is defined
